<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons.css">
  <style> body { padding: 1em; } #output { white-space: pre-wrap; margin-top: 1em; } </style>
</head>
<body>
  <p>Select the JSON file generated by the getMongoClusterInfo.js script.</p>
  <input type="file" id="selectFiles" accept=".json,application/json" />
  <div id="output">Please select the unified JSON output file.</div>

  <script>
    function onApiLoad() {
      document.getElementById('selectFiles').onchange = function(event) {
        const files = event.target.files;
        if (files.length === 0) return;
        const file = files[0];
        const statusDiv = document.getElementById('output');
        statusDiv.textContent = `Reading file: ${file.name}...`;
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            statusDiv.textContent = "File loaded. Analysing data...";
            setTimeout(() => {
              const result = analyse(e.target.result);
              statusDiv.textContent = "Analysis finished. Writing results to spreadsheet...";
              google.script.run
                .withSuccessHandler(() => google.script.host.close())
                .withFailureHandler(onFailure)
                .addResults(result);
            }, 50);
          } catch (err) { onFailure(err); }
        };
        reader.onerror = function(err) { onFailure(new Error("Error reading the file.")); };
        reader.readAsText(file);
      };
    }

    function onFailure(error) {
      document.getElementById('output').innerHTML = `<strong>ERROR:</strong> ${error.message}<br><pre>${error.stack || ''}</pre>`;
    }

    function analyse(content) {
      const data = JSON.parse(content);
      const collections = [], indexes = [], searchIndexes = [];
      const mongodb = { totalSize: 0, totalStorageSize: 0, totalIndexSize: 0 };
      
      const limitationsSummary = {
          hasTimeseries: false, 
          isNotWiredTiger: false, hasZones: false, hasQueryableEncryption: false,
          hasClusteredWithTTL: false, hasDuplicateKeyConflict: false,
          hasAtlasSearchIndex: false, hasDotInName: false, hasView: false
      };

      data.forEach((section) => {
        if (section.section === "collection_info") {
            const coll = section.output;
            collections.push(coll);
            mongodb.totalSize += coll.size || 0;
            mongodb.totalStorageSize += coll.storageSize || 0;
            mongodb.totalIndexSize += coll.totalIndexSize || 0;
            
            if (coll.isTimeseries) limitationsSummary.hasTimeseries = true; 
            if (coll.hasQueryableEncryption) limitationsSummary.hasQueryableEncryption = true;
            if (coll.isClusteredWithTTL) limitationsSummary.hasClusteredWithTTL = true;
            if (coll.hasAtlasSearchIndex) limitationsSummary.hasAtlasSearchIndex = true;
            if (coll.hasDotInName) limitationsSummary.hasDotInName = true;
            if (coll.isView) limitationsSummary.hasView = true;

        } else if (section.section === "index_info") {
            const idx = section.output;
            indexes.push(idx);
            if (idx.hasDuplicateKeyConflict) limitationsSummary.hasDuplicateKeyConflict = true;

        } else if (section.section === "search_index_info") {
            searchIndexes.push(section.output);

        } else if (section.section === "cluster_info") {
            Object.assign(mongodb, section.output);
            if (mongodb.storageEngine !== 'wiredTiger') limitationsSummary.isNotWiredTiger = true;
            if (mongodb.hasZones) limitationsSummary.hasZones = true;
        }
      });

      collections.sort((a, b) => (b.size || 0) - (a.size || 0));
      indexes.sort((a, b) => (b.size || 0) - (a.size || 0));

      return {
        mongodb: mongodb, collections: collections, indexes: indexes,
        searchIndexes: searchIndexes, limitationsSummary: limitationsSummary
      };
    }
  </script>
  <script async defer src="https://apis.google.com/js/api.js?onload=onApiLoad"></script>
</body>
</html>
